<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.chua.webrtc.support.mapper.WebRtcUserMapper">

    <!-- WebRTC用户结果映射 -->
    <resultMap id="BaseResultMap" type="com.chua.webrtc.support.entity.WebRtcUser">
        <id column="webrtc_user_id" property="webrtcUserId" jdbcType="VARCHAR"/>
        <result column="webrtc_user_name" property="webrtcUserName" jdbcType="VARCHAR"/>
        <result column="webrtc_user_display_name" property="webrtcUserDisplayName" jdbcType="VARCHAR"/>
        <result column="webrtc_user_status" property="webrtcUserStatus" jdbcType="VARCHAR"/>
        <result column="webrtc_user_avatar" property="webrtcUserAvatar" jdbcType="VARCHAR"/>
        <result column="webrtc_user_device_info" property="webrtcUserDeviceInfo" jdbcType="VARCHAR"/>
        <result column="webrtc_user_ip_address" property="webrtcUserIpAddress" jdbcType="VARCHAR"/>
        <result column="webrtc_user_browser_info" property="webrtcUserBrowserInfo" jdbcType="VARCHAR"/>
        <result column="webrtc_user_current_room_id" property="webrtcUserCurrentRoomId" jdbcType="VARCHAR"/>
        <result column="webrtc_user_join_room_time" property="webrtcUserJoinRoomTime" jdbcType="TIMESTAMP"/>
        <result column="webrtc_user_leave_room_time" property="webrtcUserLeaveRoomTime" jdbcType="TIMESTAMP"/>
        <result column="webrtc_user_audio_enabled" property="webrtcUserAudioEnabled" jdbcType="BOOLEAN"/>
        <result column="webrtc_user_video_enabled" property="webrtcUserVideoEnabled" jdbcType="BOOLEAN"/>
        <result column="webrtc_user_screen_sharing" property="webrtcUserScreenSharing" jdbcType="BOOLEAN"/>
        <result column="webrtc_user_last_active_time" property="webrtcUserLastActiveTime" jdbcType="TIMESTAMP"/>
        <result column="webrtc_user_last_online_time" property="webrtcUserLastOnlineTime" jdbcType="TIMESTAMP"/>
        <result column="webrtc_user_create_time" property="webrtcUserCreateTime" jdbcType="TIMESTAMP"/>
        <result column="webrtc_user_update_time" property="webrtcUserUpdateTime" jdbcType="TIMESTAMP"/>
        <result column="webrtc_user_is_deleted" property="webrtcUserIsDeleted" jdbcType="TINYINT"/>
        <result column="webrtc_user_version" property="webrtcUserVersion" jdbcType="INTEGER"/>
        <result column="webrtc_user_remark" property="webrtcUserRemark" jdbcType="VARCHAR"/>
    </resultMap>

    <!-- 基础列名 -->
    <sql id="Base_Column_List">
        webrtc_user_id, webrtc_user_name, webrtc_user_display_name, webrtc_user_status,
        webrtc_user_avatar, webrtc_user_device_info, webrtc_user_ip_address, webrtc_user_browser_info,
        webrtc_user_current_room_id, webrtc_user_join_room_time, webrtc_user_leave_room_time,
        webrtc_user_audio_enabled, webrtc_user_video_enabled, webrtc_user_screen_sharing,
        webrtc_user_last_active_time, webrtc_user_last_online_time, webrtc_user_create_time,
        webrtc_user_update_time, webrtc_user_is_deleted, webrtc_user_version, webrtc_user_remark
    </sql>

    <!-- 根据用户名查询用户 -->
    <select id="selectByUserName" parameterType="java.lang.String" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM webrtc_user
        WHERE webrtc_user_name = #{userName}
        AND webrtc_user_is_deleted = 0
    </select>

    <!-- 根据房间ID查询房间内的用户列表 -->
    <select id="selectByRoomId" parameterType="java.lang.String" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM webrtc_user
        WHERE webrtc_user_current_room_id = #{roomId}
        AND webrtc_user_is_deleted = 0
        ORDER BY webrtc_user_join_room_time ASC
    </select>

    <!-- 查询在线用户列表 -->
    <select id="selectOnlineUsers" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM webrtc_user
        WHERE webrtc_user_status = 'ONLINE'
        AND webrtc_user_is_deleted = 0
        ORDER BY webrtc_user_last_online_time DESC
    </select>

    <!-- 查询房间内用户数量 -->
    <select id="countByRoomId" parameterType="java.lang.String" resultType="int">
        SELECT COUNT(*)
        FROM webrtc_user
        WHERE webrtc_user_current_room_id = #{roomId}
        AND webrtc_user_is_deleted = 0
    </select>

    <!-- 更新用户状态 -->
    <update id="updateUserStatus">
        UPDATE webrtc_user
        SET webrtc_user_status = #{status},
            webrtc_user_last_online_time = NOW(),
            webrtc_user_update_time = NOW()
        WHERE webrtc_user_id = #{userId}
    </update>

    <!-- 更新用户当前房间 -->
    <update id="updateUserRoom">
        UPDATE webrtc_user
        SET webrtc_user_current_room_id = #{roomId},
            webrtc_user_join_room_time = #{joinTime},
            webrtc_user_update_time = NOW()
        WHERE webrtc_user_id = #{userId}
    </update>

    <!-- 用户离开房间 -->
    <update id="leaveRoom">
        UPDATE webrtc_user
        SET webrtc_user_current_room_id = NULL,
            webrtc_user_leave_room_time = #{leaveTime},
            webrtc_user_update_time = NOW()
        WHERE webrtc_user_id = #{userId}
    </update>

    <!-- 更新用户媒体状态 -->
    <update id="updateMediaState">
        UPDATE webrtc_user
        SET webrtc_user_audio_enabled = #{audioEnabled},
            webrtc_user_video_enabled = #{videoEnabled},
            webrtc_user_screen_sharing = #{screenSharing},
            webrtc_user_update_time = NOW()
        WHERE webrtc_user_id = #{userId}
    </update>

    <!-- 批量清空房间内所有用户的房间信息 -->
    <update id="clearRoomUsers">
        UPDATE webrtc_user
        SET webrtc_user_current_room_id = NULL,
            webrtc_user_leave_room_time = #{leaveTime},
            webrtc_user_update_time = NOW()
        WHERE webrtc_user_current_room_id = #{roomId}
    </update>

</mapper>