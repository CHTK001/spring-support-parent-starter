# ç§Ÿæˆ·åŒæ­¥åè®®å®ç°è¯´æ˜

## ğŸ“‹ å·²å®Œæˆçš„å·¥ä½œ

### 1. é…ç½®å±æ€§æ‰©å±• âœ…

åœ¨ `TenantProperties` ä¸­æ·»åŠ äº†å®Œæ•´çš„åŒæ­¥åè®®é…ç½®ï¼š

```yaml
plugin:
  mybatis-plus:
    tenant:
      enable: true
      tenant-id: sys_tenant_id

      # åŒæ­¥åè®®é…ç½®
      sync-protocol:
        # æ˜¯å¦å¯ç”¨åŒæ­¥åè®®
        enable: true
        # ç¨‹åºç±»å‹ï¼šserver-æœåŠ¡ç«¯ï¼Œclient-å®¢æˆ·ç«¯
        type: server # æˆ– client
        # æœåŠ¡ç«¯ç«¯å£ï¼ˆå½“type=serveræ—¶ç”Ÿæ•ˆï¼‰
        server-port: 19280
        # æœåŠ¡ç«¯åœ°å€ï¼ˆå½“type=clientæ—¶ç”Ÿæ•ˆï¼‰
        server-address: http://localhost:19280

        # å…ƒæ•°æ®ä¸‹å‘é…ç½®
        metadata-sync:
          # æ˜¯å¦å¯ç”¨å…ƒæ•°æ®ä¸‹å‘
          enable: true
          # ä¸‹å‘é—´éš”æ—¶é—´ï¼ˆç§’ï¼‰
          interval: 300
          # åˆå§‹å»¶è¿Ÿæ—¶é—´ï¼ˆç§’ï¼‰
          initial-delay: 60
```

### 2. SPI æ¥å£å®šä¹‰ âœ…

#### TenantMetadataProviderï¼ˆæœåŠ¡ç«¯ï¼‰

```java
/**
 * ç§Ÿæˆ·å…ƒæ•°æ®æä¾›è€…æ¥å£
 * é€šè¿‡ SPI æœºåˆ¶å®ç°ï¼Œç”¨äºæœåŠ¡ç«¯ä¸‹å‘ç§Ÿæˆ·å…ƒæ•°æ®
 */
public interface TenantMetadataProvider {
    String getName();
    int getOrder();
    Map<String, Object> getMetadata(String tenantId);
    boolean supports(String tenantId);
}
```

#### TenantMetadataConsumerï¼ˆå®¢æˆ·ç«¯ï¼‰

```java
/**
 * ç§Ÿæˆ·å…ƒæ•°æ®æ¶ˆè´¹è€…æ¥å£
 * é€šè¿‡ SPI æœºåˆ¶å®ç°ï¼Œç”¨äºå®¢æˆ·ç«¯æ¥æ”¶å’Œå¤„ç†ç§Ÿæˆ·å…ƒæ•°æ®
 */
public interface TenantMetadataConsumer {
    String getName();
    int getOrder();
    void consumeMetadata(String tenantId, Map<String, Object> metadata);
    boolean supports(String metadataType);
}
```

### 3. æœåŠ¡ç«¯å®ç° âœ…

`TenantSyncServer` - ç§Ÿæˆ·åŒæ­¥æœåŠ¡ç«¯

- å¯åŠ¨ç‹¬ç«‹çš„ HTTP æœåŠ¡å™¨ï¼ˆåŸºäº WebFluxï¼‰
- æä¾› RESTful API æ¥å£
- å®šæ—¶è§¦å‘å…ƒæ•°æ®ä¸‹å‘
- é€šè¿‡ SPI åŠ è½½æ‰€æœ‰ `TenantMetadataProvider`

**æä¾›çš„ API æ¥å£ï¼š**

- `GET /tenant/metadata/{tenantId}` - è·å–æŒ‡å®šç§Ÿæˆ·çš„å…ƒæ•°æ®
- `POST /tenant/sync` - åŒæ­¥ç§Ÿæˆ·å…ƒæ•°æ®
- `GET /tenant/health` - å¥åº·æ£€æŸ¥

### 4. å®¢æˆ·ç«¯å®ç° âœ…

`TenantSyncClient` - ç§Ÿæˆ·åŒæ­¥å®¢æˆ·ç«¯

- å®šæ—¶ä»æœåŠ¡ç«¯æ‹‰å–å…ƒæ•°æ®
- é€šè¿‡ SPI åŠ è½½æ‰€æœ‰ `TenantMetadataConsumer`
- åˆ†å‘å…ƒæ•°æ®ç»™å„ä¸ªæ¶ˆè´¹è€…å¤„ç†

### 5. è‡ªåŠ¨é…ç½® âœ…

åœ¨ `TenantConfiguration` ä¸­æ·»åŠ äº†æ¡ä»¶åŒ–é…ç½®ï¼š

- æ ¹æ® `type=server` è‡ªåŠ¨åˆ›å»ºæœåŠ¡ç«¯
- æ ¹æ® `type=client` è‡ªåŠ¨åˆ›å»ºå®¢æˆ·ç«¯

---

## ğŸ”§ åç»­éœ€è¦å®Œæˆçš„å·¥ä½œ

### 1. ä¿®å¤ä¾èµ–é—®é¢˜ âš ï¸

å½“å‰ WebFlux ä¾èµ–å­˜åœ¨é—®é¢˜ï¼Œéœ€è¦ï¼š

1. ç¡®ä¿ `spring-boot-starter-webflux` ä¾èµ–æ­£ç¡®æ·»åŠ 
2. æˆ–è€…æ”¹ç”¨ Spring MVC å®ç°æœåŠ¡ç«¯ï¼ˆé¿å… WebFlux ä¾èµ–å†²çªï¼‰

**å»ºè®®æ–¹æ¡ˆï¼š** ä½¿ç”¨ Spring MVC + RestController å®ç°æœåŠ¡ç«¯ï¼Œé¿å… WebFlux å¤æ‚æ€§

### 2. spring-system é…ç½®ï¼ˆæœåŠ¡ç«¯ï¼‰ ğŸ“

åœ¨ `spring-api-support-system-starter` ä¸­ï¼š

#### 2.1 æ·»åŠ ä¾èµ–

```xml
<dependency>
    <groupId>com.chua</groupId>
    <artifactId>spring-support-mybatis-tenant-starter</artifactId>
</dependency>
```

#### 2.2 åˆ›å»ºé…ç½®æ–‡ä»¶

`src/main/resources/config/application-tenant.yml`:

```yaml
plugin:
  mybatis-plus:
    tenant:
      enable: true
      sync-protocol:
        enable: true
        type: server
        server-port: 19280
        metadata-sync:
          enable: true
          interval: 300
          initial-delay: 60
```

#### 2.3 å®ç°å…ƒæ•°æ®æä¾›è€…

åˆ›å»º `TenantAdminAccountProvider`:

```java
@Service
public class TenantAdminAccountProvider implements TenantMetadataProvider {

    @Autowired
    private SysUserService sysUserService;

    @Autowired
    private SysTenantService sysTenantService;

    @Override
    public String getName() {
        return "tenant-admin-account";
    }

    @Override
    public Map<String, Object> getMetadata(String tenantId) {
        Map<String, Object> metadata = new HashMap<>();

        // è·å–ç§Ÿæˆ·ç®¡ç†å‘˜è´¦å·
        SysUser adminUser = sysUserService.getAdminByTenantId(tenantId);
        if (adminUser != null) {
            metadata.put("adminAccount", Map.of(
                "username", adminUser.getUsername(),
                "realName", adminUser.getRealName(),
                "email", adminUser.getEmail()
            ));
        }

        // è·å–ç§Ÿæˆ·æœåŠ¡é…ç½®
        SysTenant tenant = sysTenantService.getById(tenantId);
        if (tenant != null) {
            metadata.put("services", tenant.getEnabledServices());
            metadata.put("tenantInfo", Map.of(
                "name", tenant.getTenantName(),
                "status", tenant.getStatus(),
                "expireTime", tenant.getExpireTime()
            ));
        }

        return metadata;
    }
}
```

#### 2.4 åˆ›å»º SPI é…ç½®

`src/main/resources/META-INF/services/com.chua.tenant.support.sync.TenantMetadataProvider`:

```
com.chua.starter.system.tenant.TenantAdminAccountProvider
```

### 3. åˆ›å»ºç§Ÿæˆ·ç«¯æ¨¡å—ï¼ˆå®¢æˆ·ç«¯ï¼‰ ğŸ“

#### 3.1 åˆ›å»ºæ–°æ¨¡å—

```
spring-api-support-tenant-client-starter/
â”œâ”€â”€ pom.xml
â”œâ”€â”€ src/
â”‚   â””â”€â”€ main/
â”‚       â”œâ”€â”€ java/
â”‚       â”‚   â””â”€â”€ com/chua/starter/tenant/client/
â”‚       â”‚       â”œâ”€â”€ TenantClientApplication.java
â”‚       â”‚       â””â”€â”€ consumer/
â”‚       â”‚           â””â”€â”€ TenantMetadataUpdateConsumer.java
â”‚       â””â”€â”€ resources/
â”‚           â”œâ”€â”€ application.yml
â”‚           â”œâ”€â”€ config/
â”‚           â”‚   â””â”€â”€ application-tenant.yml
â”‚           â””â”€â”€ META-INF/
â”‚               â””â”€â”€ services/
â”‚                   â””â”€â”€ com.chua.tenant.support.sync.TenantMetadataConsumer
```

#### 3.2 pom.xml

```xml
<dependencies>
    <dependency>
        <groupId>com.chua</groupId>
        <artifactId>spring-support-mybatis-tenant-starter</artifactId>
    </dependency>
    <dependency>
        <groupId>com.chua</groupId>
        <artifactId>spring-api-support-common-entity-starter</artifactId>
    </dependency>
</dependencies>
```

#### 3.3 é…ç½®æ–‡ä»¶

`config/application-tenant.yml`:

```yaml
plugin:
  mybatis-plus:
    tenant:
      enable: true
      sync-protocol:
        enable: true
        type: client
        server-address: http://localhost:19280
        metadata-sync:
          enable: true
          interval: 300
          initial-delay: 60
```

#### 3.4 å®ç°å…ƒæ•°æ®æ¶ˆè´¹è€…

```java
@Service
@Slf4j
public class TenantMetadataUpdateConsumer implements TenantMetadataConsumer {

    @Autowired
    private LocalAdminAccountService localAdminAccountService;

    @Autowired
    private LocalServiceConfigService localServiceConfigService;

    @Override
    public String getName() {
        return "tenant-metadata-update";
    }

    @Override
    public void consumeMetadata(String tenantId, Map<String, Object> metadata) {
        log.info("[ç§Ÿæˆ·åŒæ­¥] å¼€å§‹å¤„ç†ç§Ÿæˆ· {} çš„å…ƒæ•°æ®", tenantId);

        // æ›´æ–°ç®¡ç†å‘˜è´¦å·
        if (metadata.containsKey("adminAccount")) {
            @SuppressWarnings("unchecked")
            Map<String, Object> adminAccount = (Map<String, Object>) metadata.get("adminAccount");
            localAdminAccountService.updateOrCreate(tenantId, adminAccount);
            log.info("[ç§Ÿæˆ·åŒæ­¥] æ›´æ–°ç®¡ç†å‘˜è´¦å·å®Œæˆ");
        }

        // æ›´æ–°æœåŠ¡é…ç½®
        if (metadata.containsKey("services")) {
            @SuppressWarnings("unchecked")
            List<String> services = (List<String>) metadata.get("services");
            localServiceConfigService.updateServices(tenantId, services);
            log.info("[ç§Ÿæˆ·åŒæ­¥] æ›´æ–°æœåŠ¡é…ç½®å®Œæˆ");
        }

        // æ›´æ–°ç§Ÿæˆ·ä¿¡æ¯
        if (metadata.containsKey("tenantInfo")) {
            @SuppressWarnings("unchecked")
            Map<String, Object> tenantInfo = (Map<String, Object>) metadata.get("tenantInfo");
            localServiceConfigService.updateTenantInfo(tenantId, tenantInfo);
            log.info("[ç§Ÿæˆ·åŒæ­¥] æ›´æ–°ç§Ÿæˆ·ä¿¡æ¯å®Œæˆ");
        }
    }
}
```

#### 3.5 åˆ›å»º SPI é…ç½®

`META-INF/services/com.chua.tenant.support.sync.TenantMetadataConsumer`:

```
com.chua.starter.tenant.client.consumer.TenantMetadataUpdateConsumer
```

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  spring-system (æœåŠ¡ç«¯)                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚         TenantSyncServer (HTTP Server)          â”‚   â”‚
â”‚  â”‚              Port: 19280                         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                        â†“                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚      TenantMetadataProvider (SPI)               â”‚   â”‚
â”‚  â”‚  - TenantAdminAccountProvider                   â”‚   â”‚
â”‚  â”‚  - TenantServiceProvider                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“ HTTP
                    (å…ƒæ•°æ®ä¸‹å‘)
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              spring-api-tenant-client (å®¢æˆ·ç«¯)          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚         TenantSyncClient (HTTP Client)          â”‚   â”‚
â”‚  â”‚         å®šæ—¶æ‹‰å–å…ƒæ•°æ®                            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                        â†“                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚      TenantMetadataConsumer (SPI)               â”‚   â”‚
â”‚  â”‚  - TenantMetadataUpdateConsumer                 â”‚   â”‚
â”‚  â”‚    * æ›´æ–°ç®¡ç†å‘˜è´¦å·                              â”‚   â”‚
â”‚  â”‚    * æ›´æ–°æœåŠ¡é…ç½®                                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ•°æ®æµ

```
1. æœåŠ¡ç«¯å®šæ—¶è§¦å‘ (æ¯5åˆ†é’Ÿ)
   â†“
2. è°ƒç”¨æ‰€æœ‰ TenantMetadataProvider
   â†“
3. æ”¶é›†å„ä¸ªæä¾›è€…çš„å…ƒæ•°æ®
   â†“
4. ç­‰å¾…å®¢æˆ·ç«¯è¯·æ±‚æˆ–ä¸»åŠ¨æ¨é€
   â†“
5. å®¢æˆ·ç«¯å®šæ—¶æ‹‰å– (æ¯5åˆ†é’Ÿ)
   â†“
6. æ¥æ”¶åˆ°å…ƒæ•°æ®ååˆ†å‘ç»™æ‰€æœ‰ TenantMetadataConsumer
   â†“
7. å„ä¸ªæ¶ˆè´¹è€…å¤„ç†å…ƒæ•°æ®ï¼ˆæ›´æ–°æœ¬åœ°æ•°æ®ï¼‰
```

---

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### æœåŠ¡ç«¯é…ç½®ï¼ˆspring-systemï¼‰

```yaml
plugin:
  mybatis-plus:
    tenant:
      enable: true
      sync-protocol:
        enable: true
        type: server
        server-port: 19280
        metadata-sync:
          enable: true
          interval: 300 # 5åˆ†é’Ÿ
```

### å®¢æˆ·ç«¯é…ç½®ï¼ˆtenant-clientï¼‰

```yaml
plugin:
  mybatis-plus:
    tenant:
      enable: true
      sync-protocol:
        enable: true
        type: client
        server-address: http://192.168.1.100:19280
        metadata-sync:
          enable: true
          interval: 300 # 5åˆ†é’Ÿ
```

---

## ğŸ” æµ‹è¯•éªŒè¯

### 1. å¯åŠ¨æœåŠ¡ç«¯

```bash
# å¯åŠ¨ spring-system
java -jar spring-system.jar

# æ£€æŸ¥æœåŠ¡ç«¯æ˜¯å¦å¯åŠ¨
curl http://localhost:19280/tenant/health
```

### 2. å¯åŠ¨å®¢æˆ·ç«¯

```bash
# å¯åŠ¨ tenant-client
java -jar tenant-client.jar

# æŸ¥çœ‹æ—¥å¿—ç¡®è®¤åŒæ­¥
tail -f logs/tenant-sync.log
```

### 3. æ‰‹åŠ¨è§¦å‘åŒæ­¥

```bash
# è·å–ç§Ÿæˆ·å…ƒæ•°æ®
curl http://localhost:19280/tenant/metadata/1001

# è§¦å‘åŒæ­¥
curl -X POST http://localhost:19280/tenant/sync \
  -H "Content-Type: application/json" \
  -d '{"tenantId": "1001"}'
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **ä¾èµ–é—®é¢˜**ï¼šå½“å‰ WebFlux ä¾èµ–éœ€è¦è§£å†³ï¼Œå»ºè®®æ”¹ç”¨ Spring MVC
2. **ç«¯å£å†²çª**ï¼šç¡®ä¿ 19280 ç«¯å£æœªè¢«å ç”¨
3. **ç½‘ç»œè¿é€š**ï¼šå®¢æˆ·ç«¯éœ€è¦èƒ½è®¿é—®æœåŠ¡ç«¯åœ°å€
4. **ç§Ÿæˆ· ID è·å–**ï¼šå®¢æˆ·ç«¯éœ€è¦å®ç° `getCurrentTenantId()` æ–¹æ³•
5. **SPI é…ç½®**ï¼šç¡®ä¿ SPI é…ç½®æ–‡ä»¶è·¯å¾„æ­£ç¡®

---

## ğŸš€ åç»­ä¼˜åŒ–

1. **å®‰å…¨è®¤è¯**ï¼šæ·»åŠ  AK/SK è®¤è¯æœºåˆ¶
2. **åŠ å¯†ä¼ è¾“**ï¼šä½¿ç”¨ HTTPS æˆ–æ•°æ®åŠ å¯†
3. **å¤±è´¥é‡è¯•**ï¼šæ·»åŠ é‡è¯•æœºåˆ¶
4. **ç›‘æ§å‘Šè­¦**ï¼šæ·»åŠ åŒæ­¥çŠ¶æ€ç›‘æ§
5. **æ€§èƒ½ä¼˜åŒ–**ï¼šæ‰¹é‡åŒæ­¥ã€å¢é‡åŒæ­¥

---

**ä½œè€…**: CH  
**ç‰ˆæœ¬**: 1.0.0  
**æ—¥æœŸ**: 2024/12/02
